name: Operator SLO Test

# 트리거: main 브랜치에 푸시(push)하거나 PR(pull_request)을 보낼 때 실행
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test-slo:
    # 실행 환경: 우분투 최신 버전 (GitHub가 제공하는 가상머신)
    runs-on: ubuntu-latest

    steps:
    # 1. GitHub 저장소의 코드를 내려받습니다.
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. Go 언어 환경을 설정합니다. (1.22 버전 사용)
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'

    # 3. 가상의 Kubernetes(Kind) 클러스터를 생성합니다.
    # 로컬에서 'kind create cluster' 하는 것과 같습니다.
    - name: Create Kind cluster
      uses: helm/kind-action@v1
      with:
        cluster_name: ci-cluster

    # 4. Operator 도커 이미지를 빌드합니다.
    - name: Build Operator Image
      run: |
        make docker-build IMG=my-operator:ci

    # 5. 빌드한 이미지를 Kind 클러스터 안으로 로드합니다.
    # Docker Hub에 푸시하지 않고 바로 주입하므로 빠릅니다.
    - name: Load Image into Kind
      run: |
        kind load docker-image my-operator:ci --name ci-cluster

    # 6. Operator를 배포합니다.
    - name: Deploy Operator
      run: |
        make deploy IMG=my-operator:ci

    # 7. 컨트롤러 Pod이 준비될 때까지 기다립니다.
    # CI 환경은 로컬보다 느릴 수 있어 5분(300s) 대기 설정을 둡니다.
    - name: Wait for Controller Ready
      run: |
        echo "Waiting for controller pod..."
        kubectl wait --for=condition=Ready pod -l control-plane=controller-manager -n my-operator-system --timeout=300s
        kubectl get pods -n my-operator-system

    # 8. [중요] 권한 부여 (로컬 테스트 STEP 19에서 했던 것)
    # default 서비스 어카운트에 관리자 권한을 줘서 토큰으로 조회 가능하게 합니다.
    - name: Grant RBAC Permissions
      run: |
        kubectl create clusterrolebinding default-admin --clusterrole=cluster-admin --serviceaccount=default:default

    # 9. 포트 포워딩 (백그라운드 실행)
    # CI 서버의 localhost:8443을 Pod의 8443과 연결합니다.
    - name: Port Forward Metrics
      run: |
        # 백그라운드(&)로 실행
        kubectl port-forward -n my-operator-system deployment/my-operator-controller-manager 8443:8443 &
        
        # 포트가 열릴 때까지 5초 대기
        sleep 5
        echo "Port forwarding started."

    # 10. 샘플 CR 생성 (이벤트 발생)
    # Operator가 실제로 일을 해야 메트릭이 생성되므로 CR을 만듭니다.
    - name: Create Sample CR
      run: |
        kubectl apply -f - <<EOF
        apiVersion: batch.my.domain/v1
        kind: JobOperator
        metadata:
          name: ci-test-job
          namespace: default
        spec:
          replicas: 1
          image: nginx:latest
          port: 80
        EOF
        
        # Reconcile이 돌 때까지 잠시 대기
        sleep 10
        kubectl get pods

    # 11. [검증] SLO 검증 스크립트 실행
    # 로컬에서 테스트 완료한 스크립트를 실행합니다.
    - name: Verify SLO Metrics
      run: |
        # 실행 권한 부여
        chmod +x scripts/check-slo-metrics.sh
        # 스크립트 실행
        ./scripts/check-slo-metrics.sh